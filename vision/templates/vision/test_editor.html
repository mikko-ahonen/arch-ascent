{% load static %}
{% load component_tags %}
<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tagged Editor Test</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

    <!-- Tagged Editor CSS -->
    <link href="{% static 'tagged_editor/tagged_editor.css' %}" rel="stylesheet">

    <style>
        body {
            background-color: #1a1a2e;
            color: #e4e4e4;
            padding: 40px;
        }
        .test-container {
            max-width: 600px;
            margin: 0 auto;
        }
        .debug-info {
            margin-top: 20px;
            padding: 15px;
            background: #0f0f23;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h4 class="mb-4">Tagged Editor Test Page</h4>

        <p class="text-muted small mb-3">
            Select text and click a reference button to tag it. Try creating tags that wrap to multiple lines.
        </p>

        <!-- Reference buttons -->
        <div class="mb-3">
            <button type="button" class="btn btn-sm btn-outline-primary me-2" onclick="applyTag('domainapis', '#3498db')">
                domainapis
            </button>
            <button type="button" class="btn btn-sm btn-outline-success me-2" onclick="applyTag('infrastructureservices', '#2ecc71')">
                infrastructureservices
            </button>
            <button type="button" class="btn btn-sm btn-outline-warning me-2" onclick="applyTag('paymentgateway', '#f39c12')">
                paymentgateway
            </button>
        </div>

        <!-- The editor -->
        <div class="tagged-editor-container" id="test-editor-container" data-editor-id="test-editor">
            <div class="tagged-editor-wrapper">
                <div
                    class="tagged-editor-content"
                    id="test-editor-content"
                    contenteditable="true"
                    data-placeholder="Type or paste text here to test tagging..."
                    spellcheck="false"
                >This is a test paragraph. The tags should be inserted below each line. If there is a tag, space should be made between the rows to accommodate the tag. But if there is no tag, then it should use the regular spacing. If the tag is continued on multiple lines, the tag should be shown on the line that has the longest segment.</div>
            </div>
            <input type="hidden" id="test-editor-data" name="test-editor" value="">
        </div>

        <!-- Debug info -->
        <div class="debug-info">
            <div><strong>Debug Info:</strong></div>
            <div id="debug-output">Select text to see rect info</div>
        </div>

        <!-- State display -->
        <div class="debug-info mt-3">
            <div><strong>Editor State:</strong></div>
            <pre id="state-output" style="white-space: pre-wrap; margin: 0;">No state yet</pre>
        </div>
    </div>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Tagged Editor JS -->
    <script src="{% static 'tagged_editor/tagged_editor.js' %}"></script>

    <script>
        // Initialize the editor with pre-applied tags for testing
        document.addEventListener('DOMContentLoaded', function() {
            // Pre-applied tags to test spacing:
            // - Single tag on "test paragraph"
            // - Nested tags: outer tag wraps "space should be made between the rows to accommodate the tag"
            //   and inner tag wraps "between the rows"
            const initialTags = [
                { tag: 'domainapis', color: '#3498db', start: 10, end: 24 },  // "test paragraph"
                { tag: 'paymentgateway', color: '#f39c12', start: 79, end: 139 },  // "space should be made between the rows to accommodate the tag"
                { tag: 'infrastructureservices', color: '#2ecc71', start: 102, end: 118 }  // "between the rows" (nested inside paymentgateway)
            ];

            initTaggedEditor('test-editor', initialTags, {
                availableTags: [
                    { name: 'domainapis', color: '#3498db' },
                    { name: 'infrastructureservices', color: '#2ecc71' },
                    { name: 'paymentgateway', color: '#f39c12' }
                ]
            });

            // Debug: show selection rects on mouseup
            document.getElementById('test-editor-content').addEventListener('mouseup', function() {
                showDebugInfo();
            });

            // Update state display periodically
            setInterval(updateStateDisplay, 1000);
        });

        function applyTag(tagName, color) {
            taggedEditorApplyTag('test-editor', tagName, color);
            setTimeout(showDebugInfo, 100);
        }

        function showDebugInfo() {
            const content = document.getElementById('test-editor-content');
            const selection = window.getSelection();
            let output = '';

            if (selection && !selection.isCollapsed) {
                const range = selection.getRangeAt(0);
                const rects = range.getClientRects();
                output += `Selection rects: ${rects.length}\n`;
                Array.from(rects).forEach((rect, i) => {
                    output += `  [${i}] left:${rect.left.toFixed(0)} top:${rect.top.toFixed(0)} width:${rect.width.toFixed(0)} height:${rect.height.toFixed(0)}\n`;
                });
            }

            // Show tagged span info
            const taggedSpans = content.querySelectorAll('.tagged-text');
            output += `\nTagged spans: ${taggedSpans.length}\n`;
            taggedSpans.forEach((span, i) => {
                const range = document.createRange();
                const textNodes = [];
                const walker = document.createTreeWalker(span, NodeFilter.SHOW_TEXT, null, false);
                let node;
                while (node = walker.nextNode()) {
                    textNodes.push(node);
                }

                let rects = [];
                if (textNodes.length > 0) {
                    range.setStart(textNodes[0], 0);
                    range.setEnd(textNodes[textNodes.length - 1], textNodes[textNodes.length - 1].length);
                    rects = Array.from(range.getClientRects());
                }

                output += `  [${i}] "${span.dataset.tag}" - ${rects.length} line(s)\n`;
                rects.forEach((rect, j) => {
                    output += `      line ${j}: width=${rect.width.toFixed(0)}px\n`;
                });
            });

            document.getElementById('debug-output').textContent = output || 'No selection';
        }

        function updateStateDisplay() {
            const state = getTaggedEditorState('test-editor');
            if (state) {
                document.getElementById('state-output').textContent = JSON.stringify(state, null, 2);
            }
        }
    </script>
</body>
</html>
