<div id="filter-panel" class="card mb-3" x-data="filterPanel()">
    <div class="card-header py-2">
        <div class="d-flex justify-content-between align-items-center">
            <small class="text-muted">Filter</small>
            <small class="text-muted" x-text="filteredCount + ' / ' + totalCount"></small>
        </div>
    </div>

    <div class="collapse show" id="filter-details">
        <div class="card-body">
            <!-- Status Filters -->
            <div class="mb-3">
                <label class="form-label fw-semibold small">By Analysis Status</label>
                <div class="d-flex flex-wrap gap-2">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox"
                            id="filter-active" x-model="filters.include_active">
                        <label class="form-check-label small" for="filter-active">
                            Active (<span x-text="counts.active"></span>)
                        </label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox"
                            id="filter-stale" x-model="filters.include_stale">
                        <label class="form-check-label small" for="filter-stale">
                            Stale (<span x-text="counts.stale"></span>)
                        </label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox"
                            id="filter-dormant" x-model="filters.include_dormant">
                        <label class="form-check-label small" for="filter-dormant">
                            Dormant (<span x-text="counts.dormant"></span>)
                        </label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox"
                            id="filter-not-analyzed" x-model="filters.include_not_analyzed">
                        <label class="form-check-label small" for="filter-not-analyzed">
                            Not analyzed (<span x-text="counts.not_analyzed"></span>)
                        </label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox"
                            id="filter-orphan" x-model="filters.include_orphan">
                        <label class="form-check-label small" for="filter-orphan">
                            Orphan (<span x-text="counts.orphan"></span>)
                        </label>
                    </div>
                </div>
            </div>

            <!-- Connectivity Filters -->
            <div class="mb-3">
                <label class="form-label fw-semibold small">By Connectivity</label>
                <div class="d-flex flex-wrap gap-2">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox"
                            id="filter-main-cluster" x-model="filters.include_main_cluster">
                        <label class="form-check-label small" for="filter-main-cluster">
                            Main cluster (<span x-text="connectivity.main_cluster"></span>)
                        </label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox"
                            id="filter-disconnected" x-model="filters.include_disconnected">
                        <label class="form-check-label small" for="filter-disconnected">
                            Disconnected (<span x-text="connectivity.disconnected"></span>)
                        </label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox"
                            id="filter-unused" x-model="filters.include_unused">
                        <label class="form-check-label small" for="filter-unused">
                            Unused (<span x-text="connectivity.unused"></span>)
                        </label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox"
                            id="filter-external" x-model="filters.include_external">
                        <label class="form-check-label small" for="filter-external">
                            External (<span x-text="externalCount"></span>)
                        </label>
                    </div>
                </div>
            </div>

            <!-- Group Filter -->
            <div class="mb-3">
                <label class="form-label fw-semibold small">By Group</label>
                <div class="d-flex flex-wrap gap-2">
                    {% for group in groups %}
                    <div class="form-check form-check-inline">
                        <input class="form-check-input group-checkbox" type="checkbox"
                            id="group-{{ group.id }}" value="{{ group.id }}"
                            data-group-id="{{ group.id }}"
                            :checked="filters.selected_groups.includes('{{ group.id }}')"
                            @change="toggleGroup('{{ group.id }}', $event.target.checked)">
                        <label class="form-check-label small" for="group-{{ group.id }}">
                            {{ group.name }} (<span class="text-muted">{{ group.project_count }}</span>)
                        </label>
                    </div>
                    {% empty %}
                    <span class="text-muted small">No groups</span>
                    {% endfor %}
                </div>
                <!-- Hidden select to store values for form compatibility -->
                <select class="d-none" id="filter-groups" multiple x-model="filters.selected_groups">
                    {% for group in groups %}
                    <option value="{{ group.id }}">{{ group.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Tag Filter -->
            <div class="mb-3">
                <label class="form-label fw-semibold small">By Tag</label>
                <div class="d-flex flex-wrap gap-2">
                    {% for tag in tags %}
                    <div class="form-check form-check-inline">
                        <input class="form-check-input tag-checkbox" type="checkbox"
                            id="tag-{{ tag.slug }}" value="{{ tag.name }}"
                            :checked="filters.selected_tags.includes('{{ tag.name }}')"
                            @change="toggleTag('{{ tag.name }}', $event.target.checked)">
                        <label class="form-check-label small" for="tag-{{ tag.slug }}">
                            {{ tag.name }} (<span class="text-muted">{{ tag.count }}</span>)
                        </label>
                    </div>
                    {% empty %}
                    <span class="text-muted small">No tags</span>
                    {% endfor %}
                </div>
            </div>

            <!-- Name Pattern -->
            <div class="mb-3">
                <label class="form-label fw-semibold small">By Name Pattern</label>
                <input type="text" class="form-control form-control-sm"
                    id="filter-pattern"
                    placeholder="e.g., service-*, *-api, payment"
                    x-model="filters.name_pattern">
                <small class="text-muted">Use * as wildcard</small>
            </div>

            <!-- Actions -->
            <div class="d-flex justify-content-between align-items-center">
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-secondary" @click="selectAll()">
                        Select All
                    </button>
                    <button class="btn btn-outline-secondary" @click="clearAll()">
                        Clear All
                    </button>
                </div>
                <button class="btn btn-sm btn-primary" @click="applyFilter()">
                    Apply Filter
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function filterPanel() {
    return {
        counts: {
            active: {{ status_counts.active }},
            stale: {{ status_counts.stale }},
            dormant: {{ status_counts.dormant }},
            not_analyzed: {{ status_counts.not_analyzed }},
            orphan: {{ status_counts.orphan }},
        },
        connectivity: {
            main_cluster: {{ connectivity_counts.main_cluster }},
            disconnected: {{ connectivity_counts.disconnected }},
            unused: {{ connectivity_counts.unused }},
        },
        externalCount: {{ external_count }},
        totalCount: {{ total_count }},
        filteredCount: {{ filtered_count }},
        filters: {
            include_active: {{ current_filter.include_active|yesno:"true,false" }},
            include_stale: {{ current_filter.include_stale|yesno:"true,false" }},
            include_dormant: {{ current_filter.include_dormant|yesno:"true,false" }},
            include_not_analyzed: {{ current_filter.include_not_analyzed|yesno:"true,false" }},
            include_orphan: {{ current_filter.include_orphan|yesno:"true,false" }},
            include_main_cluster: {{ current_filter.include_main_cluster|yesno:"true,false" }},
            include_unused: {{ current_filter.include_unused|yesno:"true,false" }},
            include_disconnected: {{ current_filter.include_disconnected|yesno:"true,false" }},
            include_external: {{ current_filter.include_external|yesno:"true,false" }},
            selected_groups: [],
            selected_tags: [],
            name_pattern: "{{ current_filter.name_pattern }}",
        },

        init() {
            // Select all groups and tags by default
            this.selectAllGroups();
            this.selectAllTags();
            // Apply filter on load
            this.applyFilter();
            // Listen for status updates from the main page
            window.addEventListener('status-updated', (e) => {
                this.refreshCounts();
            });
            // Expose refresh function globally
            window.refreshFilterCounts = () => this.refreshCounts();
        },

        refreshCounts() {
            fetch('/scope/htmx/counts/')
                .then(r => r.json())
                .then(data => {
                    this.counts = data.status;
                    this.connectivity = data.connectivity;
                    this.totalCount = data.total;
                });
        },

        selectAll() {
            this.filters.include_active = true;
            this.filters.include_stale = true;
            this.filters.include_dormant = true;
            this.filters.include_not_analyzed = true;
            this.filters.include_orphan = true;
            this.filters.include_main_cluster = true;
            this.filters.include_disconnected = true;
            this.filters.include_unused = true;
            // Note: include_external stays as-is (user must explicitly enable)
        },

        clearAll() {
            this.filters.include_active = false;
            this.filters.include_stale = false;
            this.filters.include_dormant = false;
            this.filters.include_not_analyzed = false;
            this.filters.include_orphan = false;
            this.filters.include_main_cluster = false;
            this.filters.include_disconnected = false;
            this.filters.include_unused = false;
            this.filters.include_external = false;
        },

        selectAllGroups() {
            const select = document.getElementById('filter-groups');
            this.filters.selected_groups = Array.from(select.options).map(o => o.value);
            document.querySelectorAll('.group-checkbox').forEach(cb => cb.checked = true);
        },

        clearAllGroups() {
            this.filters.selected_groups = [];
            document.querySelectorAll('.group-checkbox').forEach(cb => cb.checked = false);
        },

        toggleGroup(groupId, checked) {
            const idx = this.filters.selected_groups.indexOf(groupId);
            if (checked && idx === -1) {
                this.filters.selected_groups.push(groupId);
            } else if (!checked && idx !== -1) {
                this.filters.selected_groups.splice(idx, 1);
            }
        },

        selectAllTags() {
            this.filters.selected_tags = [{% for tag in tags %}'{{ tag.name }}'{% if not forloop.last %}, {% endif %}{% endfor %}];
            document.querySelectorAll('.tag-checkbox').forEach(cb => cb.checked = true);
        },

        clearAllTags() {
            this.filters.selected_tags = [];
            document.querySelectorAll('.tag-checkbox').forEach(cb => cb.checked = false);
        },

        toggleTag(tagName, checked) {
            const idx = this.filters.selected_tags.indexOf(tagName);
            if (checked && idx === -1) {
                this.filters.selected_tags.push(tagName);
            } else if (!checked && idx !== -1) {
                this.filters.selected_tags.splice(idx, 1);
            }
        },

        applyFilter() {
            // Convert selected_groups to integers
            const payload = {
                ...this.filters,
                selected_groups: this.filters.selected_groups.map(id => parseInt(id)),
            };

            fetch('/scope/htmx/apply/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || '',
                },
                body: JSON.stringify(payload),
            })
            .then(r => r.json())
            .then(data => {
                this.filteredCount = data.count;
                window.dispatchEvent(new CustomEvent('filter-applied', {
                    detail: {
                        project_ids: data.project_ids,
                        project_keys: data.project_keys,
                        count: data.count,
                    }
                }));
            });
        },
    };
}
</script>
